# Wasm Target Support

This project now ships a minimal Wasm builder for Fr programs. The new CLI
command `fr wasm` compiles typed Fr source into a WebAssembly module that
loads Fr bytecode via an imported helper, producing both a textual module and
metadata for host integrations.

## CLI usage

```bash
fr wasm <file.fr|ast.json|ast.bin> [-o output.wasm]
```

- `-o <path>`: Override the default `.wasm` output. Even without WABT (`wat2wasm`)
  the command writes a `.wat` plus metadata file to the same directory so you can
  later run `wat2wasm` manually.

The builder embeds the generated bytecode in a data segment and exports
`fr_run`, `fr_bytecode_start`, `fr_bytecode_end`, and `fr_bytecode_length`. The
module also exposes the linear memory so host glue code can inspect or
relocate the bytecode before calling `fr_run`.

## Metadata

Each build produces `<path>.wasm.json` describing the module:

- `bytecode_length`: number of bytes in the embedded bytecode
- `line_map`: the line map produced by `compile_ast_to_bytecode`
- `source_file`: the path passed to the CLI
- `entry_point`: always `fr_run`
- `exports`: list of exported symbols (memory + helpers)
- `imports`: the required host import (`fr.run_bytecode` taking `(i32, i32)` and returning `i32`)
- `wasm_binary`: whether a `.wasm` binary was emitted (requires `wat2wasm`)

Host developers should implement the imported helper to read the bytecode from memory and run it using the Fr runtime logic in their environment.

## Requirements & next steps

- The Wasm builder currently requires all functions to be statically typed and forbids C imports.
- Installing WABT (`wat2wasm`) lets the CLI produce `.wasm` binaries automatically; otherwise you can run `wat2wasm out.wat -o out.wasm` yourself.
- Future work includes wiring this module into the JS/TS extension glue, adding wasm-specific tests, and providing prebuilt host adapters for console I/O and timers.
